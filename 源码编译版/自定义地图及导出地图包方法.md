# CARLA 地图自定义方法

> 本文档说明如何将 RoadRunner 场景导入 CARLA，包含导入流程、示例 JSON、常见故障排查以及打包方法（Cook/Package）。

---

## RoadRunner 到 CARLA：快速导入流程（总结）

1. 在 RoadRunner 中建立场景并导出（OpenDrive `.xodr`、场景几何 `.fbx`、纹理/材质等）。
2. 将导出的文件夹拷贝到仓库根的 `Import/` 目录，并在地图文件夹下创建导入用的 JSON 配置（示例见下）。
3. 在 CARLA 根目录运行 `make import`（脚本会读取 `Import/` 下的 JSON 并将资源导入到 `Unreal/CarlaUE4/Content/<Package>/...`），导入后可运行 `make launch` 在编辑器中检查场景。

---

## 详细步骤（含示例 JSON 与文件结构）

### 1. 在 RoadRunner 中导出场景

- 导出内容：OpenDrive（`.xodr`）、场景几何（一个或多个 `.fbx`）、纹理/材质文件。
- 导出选项建议：
  - 导出 OpenDrive（XODR），确保道路与车道信息完整。
  - 导出 FBX（Binary），包含法线与切线；贴图可一并导出或放在同一目录。
  - 单位为米（1:1 缩放）。
  - 若使用瓦片（tiles），请按 `*_Tile_*` 或有序命名，`Import.py` 支持 `tiles` 列表。

### 2. 组织导出文件夹（示例）

```
MyMapPackage/
├─ MyMap.xodr
├─ MyMap.fbx                 # 单文件场景（或）
├─ MyMap_Tile_0.fbx          # 瓦片示例
├─ MyMap_Tile_1.fbx
├─ Textures/
├─ Materials/
├─ roadpainter_decals.json   # 可选：roadpainter 的贴花配置
└─ MyMap.json                # 导入用 map json（示例见下）
```

### 3. Map JSON 格式（Import.py 可识别）

- 单文件示例：

```json
{
  "maps": [
    {
      "name": "HighD",
      "source": "/carla_env/carla/carla/Import/HighD/HighD.fbx",
      "use_carla_materials": false,
      "xodr": "/carla_env/carla/carla/Import/HighD/HighD.xodr"
    }
  ]
}
```

- 瓦片示例：

```json
{
  "maps": [
    {
      "name": "MyMap",
      "xodr": "MyMap.xodr",
      "use_carla_materials": false,
      "tiles": [
        "MyMap_Tile_0.fbx",
        "MyMap_Tile_1.fbx"
      ],
      "tile_size": 2000
    }
  ],
  "props": []
}
```

### 4. 将文件拷贝到 CARLA 的 `Import/` 目录

- 将 `MyMapPackage/` 放到仓库根的 `Import/` 下：`carla/Import/MyMapPackage/`。

### 5. 运行导入命令

```bash
make import
```

说明：`make import` 会运行 `Util/BuildTools/Import.py`，该脚本会：

- 读取 `Import/` 下的 JSON（或自动生成 package json）；
- 为 UE4 生成 import 设置并通过 `UE4Editor -run=ImportAssets` 将 FBX 导入到 `Unreal/CarlaUE4/Content/<Package>/Static` 与 `.../Maps`；
- 将 `.xodr` 复制到 `Unreal/CarlaUE4/Content/<Package>/Maps/<MapName>/OpenDrive`；
- 调用 `PrepareAssetsForCooking`、`LoadAssetMaterials`，并生成 `<Package>.Package.json` 到 `Unreal/CarlaUE4/Content/<Package>/Config/`。

### 6. 检查与 Cook

- 导入后可以运行 `make launch` 在编辑器中检查地图（光照、蓝图、材质等）；
- 若要为二进制 CARLA 生成可加载的 Cooked 内容，可运行打包脚本或使用 RunUAT（见下“打包方法”）。

---

## 注意事项与故障排查

- 确保 FBX 名称与 JSON 中的 `source` 或 `tiles` 名称一致，且 XODR 文件名与 `maps[].name` 逻辑匹配；
- `Import.py` 会为大瓦片分批导入以控制内存，使用 `tile_size` 控制分批大小；
- 必须设置 `UE4_ROOT` 环境变量指向正确的引擎安装目录，否则脚本无法调用 `UE4Editor`；
- 如果容器内没有完整 UE 环境，可在另一台安装了相同 UE 版本的机器上完成导入或 Cook，再把结果拷回目标环境。

---

# CARLA 地图打包方法

概述：为二进制版本导出已烹饪（Cooked）的地图，常用两种方法：使用 CARLA 自带的打包脚本（推荐）或直接使用 Unreal Automation Tool（RunUAT，灵活）。两者均可生成 CARLA 可加载的 Cooked 内容（如 `LinuxNoEditor` 目录或 `.pak` 文件），但需确保使用的引擎版本与目标二进制一致，并指定目标平台为 Linux。

## 方法一（推荐）

- 脚本路径（相对仓库）：`carla/Util/BuildTools/Package.sh`。
- 说明：自动处理 Cook、Stage、Archive 并打包为 CARLA 可发布的 `tar.gz`（或单独 package）。适合打包整个 CARLA 或单个 package（如 HighD）。

示例：

```bash
./Util/BuildTools/Package.sh --packages=HighD
```

## 方法二（RunUAT / 更灵活）

- UAT 脚本路径（相对工程）：`UE4/UnrealEngine_4.26/Engine/Build/BatchFiles/RunUAT.sh`。
- 说明：适用于需要自定义参数、针对单 Map 或做细粒度控制的场景。通常需要手动指定输出目录并将生成产物拷回 CARLA 二进制可读取的位置。

示例：

```bash
./RunUAT.sh BuildCookRun \
  -project=/carla/Unreal/CarlaUE4/CarlaUE4.uproject \
  -nocompileeditor -nop4 -cook -stage -archive -package \
  -clientconfig=Shipping -targetplatform=Linux -archivedirectory=/tmp/carla_package
```

## 关键注意事项（两种方法均适用）

- 引擎版本一致：打包时使用的 UE4/UE5 版本必须与二进制 CARLA 使用的版本相同；
- 目标平台：为运行二进制的目标（通常为 Linux）Cook 时要指定对应平台（如 `Linux` / `LinuxNoEditor`）；
- 环境变量：确保 `UE4_ROOT` 指向正确的引擎安装路径（`Package.sh` 会检查）；
- 部署：将生成的 `LinuxNoEditor` 目录或 `.pak` 放到目标二进制可读取的位置（例如目标机器的 `CarlaUE4/Paks/`）；
- 若容器内没有 UE，可在有相同 UE 的宿主机上执行打包，然后把产物拷回容器。

## 快速流程建议

1. 使用 `make import` 导入自定义地图，并在编辑器（`make launch`）中验证能打开且无蓝图/光照错误；
2. 使用方法一（`Package.sh`）快速生成包：在 `carla/` 下运行 `./Util/BuildTools/Package.sh --packages=<YourPackage>`；
3. 若需定制单 map 或特殊参数，使用方法二调用 RunUAT 或 Editor 的 cook 命令；
4. 将产物拷入目标二进制的 `Paks/` 或相应目录，使用 `/Game/` 的 Asset 路径加载地图（例如 `/Game/HighD/Maps/HighD/HighD`）。

---

（文件生成于仓库根，路径相对引用已使用相对路径）

