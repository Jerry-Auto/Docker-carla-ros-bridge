# 环境构建方法

> 本文档说明如何准备 CARLA 开发/运行环境（基于 Ubuntu 20.04）的两部分内容：本地 APP 文件夹（宿主机）和可运行的 Docker 镜像（容器）。

---

## 目录概览

下载APP文件，网盘链接如下：

https://www.123865.com/s/IR8MTd-UJev3

项目目录结构（顶层 2 层）：

```
/carla_env$ tree -L 2
.
├── UE4
│   └── UnrealEngine_4.26
├── carla
│   ├── Mapfile
│   ├── carla
│   └── test_git.sh
├── scripts
│   ├── carla_server.log
│   ├── carla_server.pid
│   └── start_carla.sh
├── third
│   ├── CarlaGUI-v2.1
│   └── roadfiles
├── 环境构建方法.md
└── 自定义地图及导出地图包方法.md
```

---

## 一、APP 文件夹（宿主机）

- 要求：将当前仓库内的所有文件下载到宿主机某目录，**保持文件结构不变**（放在哪都可以，只要路径一致即可）。
- 示例：将整个目录放到 `/home/yourname/path/to/carla_env`。

> 提示：后续容器运行时我们会把宿主机的 home 挂载到容器中（`-v "$HOME":"$HOME"`），因此最好将 `carla_env` 放在宿主机的用户目录下以便挂载访问。

---

## 二、Ubuntu 20.04 -> Docker 镜像（运行方式）

镜像内集成了 RoadRunner、CarlaGUI 以及常用配置。运行示例：


```bash
docker pull crpi-d390lxwlwm12oflr.cn-shanghai.personal.cr.aliyuncs.com/carla_env/carla_dev_env:914

sudo docker run -dit \
  --gpus all \
  -e NVIDIA_DRIVER_CAPABILITIES=all,utility,vulkan,graphics,compute \
  -e VK_ICD_FILENAMES=/usr/share/vulkan/icd.d/nvidia_icd.json \
  -e XAUTHORITY="$HOME/.Xauthority" \
  -e DISPLAY="$DISPLAY" \
  -e LANG=C.UTF-8 \
  -e LC_ALL=C.UTF-8 \
  --name carla \
  --net host \
  -v /dev:/dev \
  -v "$HOME":"$HOME" \
  -v /tmp/.X11-unix:/tmp/.X11-unix \
  -v /usr/share/vulkan/icd.d/nvidia_icd.json:/usr/share/vulkan/icd.d/nvidia_icd.json:ro \
  -v "$HOME/.Xauthority":"$HOME/.Xauthority":ro \
  -v /usr/share/fonts:/usr/share/fonts:ro \
  -v "$HOME/.local/share/fonts":"$HOME/.local/share/fonts":ro \
  -w "$HOME" \
  crpi-d390lxwlwm12oflr.cn-shanghai.personal.cr.aliyuncs.com/carla_env/carla_dev_env:914 \
  /bin/bash
```

说明：
- `--gpus all`：启用容器访问所有 GPU（需主机支持 NVIDIA Container Toolkit）。
- `--net host`：使用主机网络（方便显示、IPC 与性能）。
- `-v "$HOME":"$HOME"`：将宿主主目录挂载到容器，确保容器内可以访问宿主上的 `carla_env` 等文件。

### 容器内的后续操作

进入容器后（例如 `docker exec -it carla /bin/bash`），通常需要执行以下两步：

1. 更新字体缓存（确保 GUI 显示正常）：

```bash
# 以 root 或具有权限的用户运行
fc-cache -fv
```

2. 创建软链接（将容器的 `/carla` 指向宿主机的 `carla_env` 路径，按需调整路径）：

```bash
# 将 /carla 链接到宿主机挂载的 carla_env，例如：
ln -sfn /home/yourname/path/to/carla_env /carla
```

说明：
- `ln -sfn <目标路径> <链接路径>` 使用强制替换（`-f`）并保持符号链接（`-n`）以避免出错；根据需要调整为你实际的宿主机路径。
- 若你已经将宿主机的 `$HOME` 挂载到容器，`/home/yourname/path/to/carla_env` 应为容器内可见的路径（与宿主机路径一致）。

---

## 三、软件运行方式

### 1. RoadRunner 2023a

- 运行方式：在任意目录下执行 `roadrunner` 即可打开应用。
- 建议：保存的文件建议放到 `/carla_env/third/roadfiles` 下，便于统一管理与挂载。

### 2. UE4 与 CARLA

- 启动脚本：`/carla_env/scripts/start_carla.sh`（相对于宿主机目录，请根据实际路径调整）。

- 使用说明：

```text
Usage: $0 [--no-render|--headless] [--game|--editor] [--low-quality|-l] [--offscreen|-nr] [--quality <level>] [--] [UE4 args]
  --no-render/--headless   Disable rendering and run headless (adds -nullrhi -unattended -nop4 -nosound).
  --game/-g                Run UE4 in 'game' mode (no editor UI; shows world window). Default.
  --editor/-e              Run UE4Editor (open editor UI instead of game mode).
  --low-quality/-l         Start with Low quality (overrides default High).
  --quality/-q <level>     Set quality level (e.g. Low, Medium, High).
  --offscreen/-nr          Run with offscreen rendering (using Xvfb if available).
  --                       End of options; following args passed verbatim to UE4.
```

- 常用示例：

```bash
# 进入 UE4 编辑器（带 UI）
./start_carla.sh -e

# 以低画质运行 CARLA（Game 模式）
./start_carla.sh -l

# 无渲染（Headless）运行
./start_carla.sh --no-render

# 低画质并使用离屏渲染（如果需要在无显示环境下运行）
./start_carla.sh -l --offscreen
```

- 备注：请根据容器或宿主机的路径结构确认脚本位置（`/carla_env/scripts` vs `/carla_env/script`），并确保脚本具有可执行权限（`chmod +x start_carla.sh`）。

### 3. CARLA GUI (CarlaGUI-v2.1)

- 仓库位置（宿主机）：`/carla_env/third/CarlaGUI-v2.1`
- 容器内位置（示例）：`/home/carla/CarlaGUI-v2.1`

示例目录：

```bash
carla@MSI:~/CarlaGUI-v2.1$ ls
app  config.ini  python  readme.md  requirements.txt  start.bat  start.sh
```

启动：

```bash
# 进入目录并运行（确保有执行权限）
cd /home/carla/CarlaGUI-v2.1
chmod +x start.sh
./start.sh
```
或者直接 
```bash
GUI
```

依赖（可选）：

```bash
# 若需要在源码版本中运行 Python 部分，先安装依赖
pip3 install -r requirements.txt --user
```

功能说明：
- 只有二进制版本carla能设置carla可执行文件路径。
- 源码版本carla在容器内运行时需要将carla路径指向start_carla.sh,但是不推荐，因为参数不匹配，这个路径只有启动carla服务端一个功能，建议就不用了

注意事项：
- 若 GUI 无法显示或报错，先确认容器的 DISPLAY、X11 挂载以及字体缓存已正确配置（见上文“容器内的后续操作”）；

